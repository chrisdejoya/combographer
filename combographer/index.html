<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Combo Input Display</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #settingsPanel.settings-hidden {
      display: none;
    }
    #comboDisplay {
      min-height: 50px;
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen">

  <h1 class="text-3xl font-bold mb-6">Combo Input Display</h1>

  <!-- Combo Display -->
  <div id="comboDisplay" class="w-3/4 p-4 bg-gray-800 rounded text-lg text-yellow-300 text-center">
    Combos will appear here...
  </div>

  <!-- Toggle Button -->
  <button id="toggleSettings" class="mt-6 px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">
    Settings
  </button>

  <!-- Settings Panel -->
  <div id="settingsPanel" class="settings-hidden mt-4 p-4 bg-gray-800 rounded w-3/4">
    <h2 class="text-xl mb-4">Settings</h2>

    <!-- Clear Delay -->
    <label class="block mb-2">
      Clear Delay (ms):
      <input type="number" id="clear-delay" value="2000" class="ml-2 text-black p-1 rounded">
    </label>

    <!-- Profile Select -->
    <label class="block mb-2">
      Profile:
      <select id="profile-select" class="ml-2 text-black p-1 rounded">
        <option value="2xko">2XKO</option>
        <option value="street-fighter">Street Fighter</option>
        <option value="tekken">Tekken</option>
        <option value="gg-dbfz">GG/DBFZ</option>
        <option value="custom">Custom</option>
      </select>
    </label>

    <!-- Button Mappings -->
    <div id="buttonMappings" class="mt-4"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let gamepad = null;
      let prevButtons = [];
      let comboString = "";
      let clearTimer = null;

      const DEADZONE = 0.5;

      const comboDisplay = document.getElementById("comboDisplay");
      const toggleSettingsBtn = document.getElementById("toggleSettings");
      const settingsPanel = document.getElementById("settingsPanel");
      const clearDelayInput = document.getElementById("clear-delay");
      const profileSelect = document.getElementById("profile-select");
      const buttonMappingsDiv = document.getElementById("buttonMappings");

      // --- Profiles ---
      const PROFILES = {
        "2xko": {
          0: "T", 1: "H", 2: "L", 3: "M",
          4: "P", 5: "D", 6: "S1", 7: "S2",
          10: "Th", 11: "Ta"
        },
        "street-fighter": {
          0: "LP", 1: "MP", 2: "HP", 3: "LK",
          4: "MK", 5: "HK", 6: "P", 7: "K",
          10: "Throw", 11: "Taunt"
        },
        "tekken": {
          0: "1", 1: "2", 2: "3", 3: "4"
        },
        "gg-dbfz": {
          0: "A", 1: "B", 2: "C", 3: "D",
          4: "L1", 5: "R1", 6: "L2", 7: "R2",
          10: "LS", 11: "RS",
          "←": "4", "→": "6", "↓": "2", "↑": "8",
          "↘": "3", "↙": "1", "↖": "7", "↗": "9"
        },
        "custom": {}
      };

      let currentProfile = "2xko";
      let buttonMapping = { ...PROFILES[currentProfile] };

      // --- Toggle settings ---
      toggleSettingsBtn.addEventListener("click", () => {
        settingsPanel.classList.toggle("settings-hidden");
      });

      // --- Create button mapping UI ---
      function createButtonMappingUI(buttonCount) {
        buttonMappingsDiv.innerHTML = "";
        for (let i = 0; i < buttonCount; i++) {
          const div = document.createElement("div");
          div.classList.add("mapping");
          const label = document.createElement("label");
          label.textContent = `Button ${i}: `;
          const input = document.createElement("input");
          input.type = "text";
          input.value = buttonMapping[i] || "";
          input.dataset.index = i;
          input.classList.add("ml-2", "text-black", "p-1", "rounded");
          input.addEventListener("input", (e) => {
            buttonMapping[e.target.dataset.index] = e.target.value;
            if (currentProfile !== "custom") {
              currentProfile = "custom";
              profileSelect.value = "custom";
            }
            PROFILES["custom"] = { ...buttonMapping };
          });
          div.appendChild(label);
          div.appendChild(input);
          buttonMappingsDiv.appendChild(div);
        }
      }

      // --- Update UI with profile mapping ---
      function updateMappingUI() {
        const inputs = buttonMappingsDiv.querySelectorAll("input");
        inputs.forEach((input) => {
          const idx = input.dataset.index;
          input.value = buttonMapping[idx] || "";
        });
      }

      // --- Load selected profile ---
      profileSelect.addEventListener("change", (e) => {
        currentProfile = e.target.value;
        buttonMapping = { ...PROFILES[currentProfile] };
        updateMappingUI();
      });

      // --- Clear combo display ---
      function clearCombo() {
        comboString = "";
        comboDisplay.textContent = "Combos will appear here...";
      }

      // --- Add input to combo string ---
      function addInput(input) {
        if (!comboString) {
          comboString = input;
        } else if (comboString.endsWith(input)) {
          // prevent duplicate spamming
        } else if (comboString.endsWith("> " + input)) {
          // prevent duplicate motions
        } else {
          comboString += " > " + input;
        }
        comboDisplay.textContent = comboString;

        if (clearTimer) clearTimeout(clearTimer);
        clearTimer = setTimeout(clearCombo, parseInt(clearDelayInput.value, 10));
      }

      // --- D-pad mapping ---
      function getDpadDirection(buttons) {
        if (buttons[12]?.pressed) return "↑";
        if (buttons[13]?.pressed) return "↓";
        if (buttons[14]?.pressed) return "←";
        if (buttons[15]?.pressed) return "→";
        return null;
      }

      // --- Stick mapping ---
      function getDirection(x, y) {
        if (Math.abs(x) < DEADZONE && Math.abs(y) < DEADZONE) return null;

        if (y < -DEADZONE && x < -DEADZONE) return "↖";
        if (y < -DEADZONE && x > DEADZONE) return "↗";
        if (y > DEADZONE && x < -DEADZONE) return "↙";
        if (y > DEADZONE && x > DEADZONE) return "↘";
        if (y < -DEADZONE) return "↑";
        if (y > DEADZONE) return "↓";
        if (x < -DEADZONE) return "←";
        if (x > DEADZONE) return "→";
        return null;
      }

      // --- Process gamepad input ---
      function processInput() {
        const buttons = gamepad.buttons;
        const axes = gamepad.axes;

        // Buttons
        for (let i = 0; i < buttons.length; i++) {
          const pressed = buttons[i].pressed;
          if (pressed && !prevButtons[i]) {
            if (i === 8) {
              // backspace
              comboString = comboString.replace(/\s*(>?\s*[^>+\s]+(\+[^>+\s]+)*)$/, "");
              comboDisplay.textContent = comboString || "Combos will appear here...";
            } else {
              const mapped = buttonMapping[i];
              if (mapped) addInput(mapped);
            }
          }
        }

        // D-pad
        const dpadDir = getDpadDirection(buttons);
        if (dpadDir) addInput(dpadDir);

        // Left stick
        const lsDir = getDirection(axes[0], axes[1]);
        if (lsDir) addInput(lsDir);

        prevButtons = buttons.map((b) => b.pressed);
      }

      // --- Main loop ---
      function gameLoop() {
        if (!gamepad) {
          requestAnimationFrame(gameLoop);
          return;
        }
        const freshGamepad = navigator.getGamepads()[gamepad.index];
        if (freshGamepad) {
          gamepad = freshGamepad;
          processInput();
        }
        requestAnimationFrame(gameLoop);
      }

      // --- Detect gamepad connection ---
      window.addEventListener("gamepadconnected", (e) => {
        gamepad = e.gamepad;
        prevButtons = gamepad.buttons.map(() => false);
        createButtonMappingUI(gamepad.buttons.length);
        updateMappingUI();
        requestAnimationFrame(gameLoop);
      });
    });
  </script>

</body>
</html>
